<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка SonnyWorld</title>
    <style>
        :root { --blue: #3b82f6; --green: #10b981; --red: #ef4444; --telegram: #0088cc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #f8fafc; color: #1e293b; }
        .admin-container { max-width: 1200px; margin: auto; padding: 20px; }
        
        .header { background: linear-gradient(135deg, #1e3a8a 0%, var(--blue) 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h2 { font-size: 32px; color: var(--blue); margin-bottom: 10px; }
        
        .orders-table { width: 100%; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin: 30px 0; }
        .orders-table th, .orders-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .orders-table th { background: #f1f5f9; font-weight: bold; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; }
        .btn-success { background: var(--green); }
        .btn-danger { background: var(--red); }
        .btn-telegram { background: var(--telegram); }
        .btn-yoomoney { background: #7c3aed; }
        
        .search-box { background: white; padding: 20px; border-radius: 10px; margin: 30px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .search-box input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; width: 300px; margin-right: 10px; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #059669; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Админ панель SonnyWorld</h1>
            <p>Панель управления донатами</p>
            <a href="index.html" style="color: white; margin-top: 15px; display: inline-block;">? Вернуться на сайт</a>
        </div>
        
        <div class="search-box">
            <h3><i class="fas fa-search"></i> Найти заказ</h3>
            <input type="text" id="searchOrderId" placeholder="Введите ID заказа или ник">
            <button class="btn" onclick="searchOrder()" style="background: var(--blue);">Найти</button>
            <button class="btn" onclick="refreshOrders()" style="background: var(--green); margin-left: 10px;">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
            <button class="btn" onclick="exportOrders()" style="background: #7c3aed; margin-left: 10px;">
                <i class="fas fa-download"></i> Экспорт
            </button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h2 id="totalOrders">0</h2>
                <p>Всего заказов</p>
            </div>
            <div class="stat-card">
                <h2 id="totalIncome">0 ?</h2>
                <p>Общий доход</p>
            </div>
            <div class="stat-card">
                <h2 id="pendingOrders">0</h2>
                <p>Ожидают выдачи</p>
            </div>
            <div class="stat-card">
                <h2 id="telegramOrders">0</h2>
                <p>Через Telegram</p>
            </div>
        </div>
        
        <h2>Заказы ожидающие выдачи</h2>
        <table class="orders-table">
            <thead>
                <tr>
                    <th>ID заказа</th>
                    <th>Игрок</th>
                    <th>Привилегия</th>
                    <th>Сумма</th>
                    <th>Тип</th>
                    <th>Дата</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="ordersList">
                <tr><td colspan="8" style="text-align: center; padding: 30px;">Загрузка заказов...</td></tr>
            </tbody>
        </table>
    </div>
    
    <script>
        // ПАРОЛЬ АДМИНКИ: sonny2026
        const password = prompt("Пароль админ панели:");
        if (password !== "sonny2026") {
            alert("Неверный пароль!");
            window.location.href = "index.html";
        }
        
        // Загрузка заказов
        function loadOrders() {
            try {
                const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
                
                // Статистика
                document.getElementById('totalOrders').textContent = orders.length;
                document.getElementById('pendingOrders').textContent = orders.filter(o => o.status === 'pending').length;
                
                const telegramOrders = orders.filter(o => o.isFree && o.status === 'pending');
                document.getElementById('telegramOrders').textContent = telegramOrders.length;
                
                const paidOrders = orders.filter(o => !o.isFree && o.status === 'completed');
                const totalIncome = paidOrders.reduce((sum, order) => sum + order.price, 0);
                document.getElementById('totalIncome').textContent = totalIncome + ' ?';
                
                // Таблица
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = '';
                
                // Сначала показываем ожидающие, потом завершенные
                const pendingOrders = orders.filter(o => o.status === 'pending').reverse();
                const completedOrders = orders.filter(o => o.status === 'completed').reverse();
                
                if (pendingOrders.length === 0 && completedOrders.length === 0) {
                    ordersList.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">Заказов нет</td></tr>';
                    return;
                }
                
                // Ожидающие
                pendingOrders.forEach(order => {
                    addOrderRow(order);
                });
                
                // Разделитель
                if (pendingOrders.length > 0 && completedOrders.length > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="8" style="background: #f8fafc; padding: 10px; text-align: center; font-weight: bold; color: #64748b;">
                            <i class="fas fa-check-circle"></i> Выданные привилегии
                        </td>
                    `;
                    ordersList.appendChild(separatorRow);
                }
                
                // Завершенные
                completedOrders.forEach(order => {
                    addOrderRow(order);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки заказов:', error);
                document.getElementById('ordersList').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; padding: 30px; color: red;">Ошибка загрузки заказов</td></tr>';
            }
        }
        
        // Добавить строку в таблицу
        function addOrderRow(order) {
            const ordersList = document.getElementById('ordersList');
            const date = new Date(order.date).toLocaleString('ru-RU');
            const completedDate = order.completedAt ? new Date(order.completedAt).toLocaleString('ru-RU') : '-';
            
            const row = document.createElement('tr');
            row.style.background = order.status === 'completed' ? '#f0fdf4' : 'white';
            
            // Определяем тип
            let typeBadge = '';
            if (order.isFree) {
                typeBadge = '<span class="status-badge btn-telegram" style="background: var(--telegram); color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px;"><i class="fab fa-telegram"></i> Telegram</span>';
            } else {
                typeBadge = '<span class="status-badge btn-yoomoney" style="background: #7c3aed; color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px;"><i class="fas fa-wallet"></i> ЮMoney</span>';
            }
            
            row.innerHTML = `
                <td><code>${order.id}</code></td>
                <td>
                    <strong>${order.nickname}</strong><br>
                    <small style="color: #64748b;">Подпись: ${order.signature}</small>
                </td>
                <td>${order.donate}</td>
                <td>
                    ${order.isFree 
                        ? '<span style="color: var(--telegram); font-weight: bold;">Бесплатно</span>' 
                        : '<span style="color: #7c3aed; font-weight: bold;">' + order.price + ' ?</span>'}
                </td>
                <td>${typeBadge}</td>
                <td>${date}</td>
                <td>
                    ${order.status === 'pending' 
                        ? '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Ожидает</span>' 
                        : '<span class="status-badge status-completed"><i class="fas fa-check"></i> Выдан</span><br><small>' + completedDate + '</small>'}
                </td>
                <td>
                    ${order.status === 'pending' 
                        ? `<button class="btn btn-success" onclick="completeOrder('${order.id}')" style="margin-right: 5px;">
                              <i class="fas fa-check"></i> Выдать
                           </button>
                           <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">
                              <i class="fas fa-trash"></i>
                           </button>`
                        : `<button class="btn" onclick="copyCommand('${order.nickname}', '${order.donate}')" style="background: var(--blue);">
                              <i class="fas fa-copy"></i> Команда
                           </button>
                           <button class="btn" onclick="viewOrderDetails('${order.id}')" style="background: #6b7280; margin-left: 5px;">
                              <i class="fas fa-eye"></i>
                           </button>`}
                </td>
            `;
            ordersList.appendChild(row);
        }
        
        // Выдать привилегию
        function completeOrder(orderId) {
            const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) {
                alert("Заказ не найден!");
                return;
            }
            
            const order = orders[orderIndex];
            
            // Для платных заказов проверяем подтверждение оплаты
            if (!order.isFree) {
                const checkPayment = confirm(`Заказ ${orderId} на сумму ${order.price} ?\n\nВы уверены, что оплата прошла успешно?\nПроверьте в кошельке ЮMoney перед выдачей.`);
                if (!checkPayment) return;
            }
            
            const groupName = order.donate.toLowerCase().replace('.', '').replace(' ', '_');
            const command = `/lp user ${order.nickname} parent add ${groupName}`;
            
            const message = order.isFree 
                ? `Выдать бесплатную привилегию ${order.donate} игроку ${order.nickname}?\n\nИгрок подтвердил подписку на Telegram.`
                : `Выдать привилегию ${order.donate} игроку ${order.nickname} за ${order.price} ?\n\nОплата подтверждена через ЮMoney.`;
            
            if (confirm(message + `\n\nКоманда для выдачи:\n${command}`)) {
                // Копируем команду
                navigator.clipboard.writeText(command).then(() => {
                    // Меняем статус
                    orders[orderIndex].status = 'completed';
                    orders[orderIndex].completedAt = new Date().toISOString();
                    localStorage.setItem('sonny_orders', JSON.stringify(orders));
                    
                    alert("? Команда скопирована в буфер обмена!\n\nВставьте команду в консоль сервера для выдачи привилегии.");
                    loadOrders();
                    
                    // Уведомление звуком
                    try {
                        new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3').play();
                    } catch (e) {}
                }).catch(err => {
                    alert("Ошибка копирования команды: " + err);
                });
            }
        }
        
        // Копировать команду
        function copyCommand(nickname, donate) {
            const groupName = donate.toLowerCase().replace('.', '').replace(' ', '_');
            const command = `/lp user ${nickname} parent add ${groupName}`;
            
            navigator.clipboard.writeText(command).then(() => {
                alert("? Команда скопирована:\n" + command);
            });
        }
        
        // Просмотр деталей заказа
        function viewOrderDetails(orderId) {
            const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                alert("Заказ не найден!");
                return;
            }
            
            const date = new Date(order.date).toLocaleString('ru-RU');
            const completedDate = order.completedAt ? new Date(order.completedAt).toLocaleString('ru-RU') : 'Не выдано';
            const status = order.status === 'completed' ? 'Выдан' : 'Ожидает выдачи';
            const type = order.isFree ? 'Бесплатный (Telegram)' : 'Платный (ЮMoney)';
            const paymentStatus = order.isFree ? 'Подписка на Telegram подтверждена' : 'Оплата через ЮMoney';
            
            Swal.fire({
                title: `Заказ ${orderId}`,
                html: `
                    <div style="text-align: left; padding: 10px;">
                        <p><b>Игрок:</b> ${order.nickname}</p>
                        <p><b>Привилегия:</b> ${order.donate}</p>
                        <p><b>Сумма:</b> ${order.isFree ? 'Бесплатно' : order.price + ' ?'}</p>
                        <p><b>Тип:</b> ${type}</p>
                        <p><b>Статус:</b> ${status}</p>
                        <p><b>Способ:</b> ${paymentStatus}</p>
                        <p><b>Дата заказа:</b> ${date}</p>
                        <p><b>Дата выдачи:</b> ${completedDate}</p>
                        <p><b>Подпись:</b> ${order.signature}</p>
                        <p><b>Telegram проверка:</b> ${order.telegramVerified ? '✅ Подтверждено' : '❌ Не подтверждено'}</p>
                        <hr>
                        <p style="color: #6b7280; margin-top: 10px;">
                            <b>Команда для выдачи:</b><br>
                            <code style="background: #f3f4f6; padding: 5px; border-radius: 4px; display: block; margin-top: 5px;">
                                /lp user ${order.nickname} parent add ${order.donate.toLowerCase().replace('.', '').replace(' ', '_')}
                            </code>
                        </p>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Закрыть',
                confirmButtonColor: '#3b82f6',
                width: '600px'
            });
        }
        
        // Удалить заказ
        function deleteOrder(orderId) {
            if (!confirm("Удалить этот заказ? Это действие нельзя отменить.")) return;
            
            const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
            const filteredOrders = orders.filter(o => o.id !== orderId);
            localStorage.setItem('sonny_orders', JSON.stringify(filteredOrders));
            
            loadOrders();
            alert("Заказ удален");
        }
        
        // Найти заказ
        function searchOrder() {
            const searchTerm = document.getElementById('searchOrderId').value.trim().toLowerCase();
            if (!searchTerm) {
                alert("Введите ID заказа или ник!");
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
            const foundOrders = orders.filter(o => 
                o.id.toLowerCase().includes(searchTerm) || 
                o.nickname.toLowerCase().includes(searchTerm)
            );
            
            if (foundOrders.length === 0) {
                alert("Заказы не найдены!");
                return;
            }
            
            let html = '<div style="text-align: left; max-height: 400px; overflow-y: auto;">';
            foundOrders.forEach(order => {
                const date = new Date(order.date).toLocaleString('ru-RU');
                const status = order.status === 'completed' ? 'Выдан' : 'Ожидает';
                const type = order.isFree ? 'Telegram' : 'ЮMoney';
                
                html += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                        <p><b>ID:</b> <code>${order.id}</code></p>
                        <p><b>Игрок:</b> ${order.nickname}</p>
                        <p><b>Привилегия:</b> ${order.donate}</p>
                        <p><b>Сумма:</b> ${order.isFree ? 'Бесплатно' : order.price + ' ?'}</p>
                        <p><b>Тип:</b> ${type}</p>
                        <p><b>Статус:</b> ${status}</p>
                        <p><b>Дата:</b> ${date}</p>
                        <button onclick="viewOrderDetails('${order.id}')" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-top: 5px; cursor: pointer;">
                            <i class="fas fa-eye"></i> Подробнее
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            Swal.fire({
                title: `Найдено заказов: ${foundOrders.length}`,
                html: html,
                width: '600px',
                confirmButtonText: 'Закрыть',
                confirmButtonColor: '#3b82f6'
            });
        }
        
        // Экспорт заказов
        function exportOrders() {
            const orders = JSON.parse(localStorage.getItem('sonny_orders')) || [];
            if (orders.length === 0) {
                alert("Нет заказов для экспорта!");
                return;
            }
            
            let csv = 'ID;Ник;Привилегия;Сумма;Тип;Статус;Дата;Подпись;Telegram проверка\n';
            
            orders.forEach(order => {
                const date = new Date(order.date).toLocaleString('ru-RU');
                const status = order.status === 'completed' ? 'Выдан' : 'Ожидает';
                const type = order.isFree ? 'Telegram' : 'ЮMoney';
                const price = order.isFree ? 'Бесплатно' : order.price + ' ?';
                
                csv += `"${order.id}";"${order.nickname}";"${order.donate}";"${price}";"${type}";"${status}";"${date}";"${order.signature}";"${order.telegramVerified ? 'Да' : 'Нет'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `sonny_orders_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Экспортировано ${orders.length} заказов`);
        }
        
        // Обновить список
        function refreshOrders() {
            loadOrders();
            document.getElementById('searchOrderId').value = '';
        }
        
        // Автоматическое обновление каждые 30 секунд
        function startAutoRefresh() {
            loadOrders();
            setTimeout(startAutoRefresh, 30000); // 30 секунд
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            startAutoRefresh();
        });
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
